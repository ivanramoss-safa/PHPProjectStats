{% extends 'base.html.twig' %}

{% block title %}Inicio - F√∫tbol Stats{% endblock %}

{% block body %}
<div class="container mt-4">

    
    <div class="row mb-4">
        <div class="col-md-6">
            <h1>üìÖ Partidos del {{ fechaActual }}</h1>
        </div>
        <div class="col-md-6 text-end">
            <form method="get" class="d-inline">
                <input type="date" name="date" value="{{ fechaActual }}" class="form-control d-inline w-auto" onchange="this.form.submit()">
            </form>
        </div>
    </div>

    <div class="row">
        
        <div class="col-md-4">
            <h4>üì∞ Noticias LaLiga</h4>
            
            
            <ul class="nav nav-tabs mb-2" id="noticiasTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="fichajes-tab" data-bs-toggle="tab" data-bs-target="#fichajes" type="button" role="tab">
                        üí∞ Fichajes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="lesiones-tab" data-bs-toggle="tab" data-bs-target="#lesiones" type="button" role="tab">
                        üè• Lesiones
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="noticias-tab" data-bs-toggle="tab" data-bs-target="#noticias" type="button" role="tab">
                        üì¢ Noticias
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="noticiasTabContent">
                
                <div class="tab-pane fade show active" id="fichajes" role="tabpanel">
                    {% if fichajes is empty %}
                        <div class="alert alert-secondary">No hay fichajes recientes.</div>
                    {% else %}
                        {% for fichaje in fichajes %}
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <img src="{{ fichaje.player.photo ?? '' }}" width="40" class="rounded-circle me-2" alt="">
                                        <div class="flex-grow-1">
                                            <strong class="d-block" style="font-size: 0.85rem">{{ fichaje.player.name }}</strong>
                                            <small class="text-muted">
                                                {{ fichaje.transfer.teams.out.name ?? '?' }} 
                                                ‚û°Ô∏è 
                                                {{ fichaje.transfer.teams.in.name ?? '?' }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">{{ fichaje.date }}</small>
                                        {% if fichaje.transfer.type %}
                                            <span class="badge bg-info ms-1">{{ fichaje.transfer.type }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                
                <div class="tab-pane fade" id="lesiones" role="tabpanel">
                    {% if lesiones is empty %}
                        <div class="alert alert-secondary">No hay lesiones recientes.</div>
                    {% else %}
                        {% for lesion in lesiones %}
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <img src="{{ lesion.player.photo ?? '' }}" width="40" class="rounded-circle me-2" alt="">
                                        <div class="flex-grow-1">
                                            <strong class="d-block" style="font-size: 0.85rem">{{ lesion.player.name }}</strong>
                                            <small class="text-muted">{{ lesion.team.name ?? '' }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-danger">{{ lesion.player.reason ?? 'Lesi√≥n' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                
                <div class="tab-pane fade" id="noticias" role="tabpanel">
                    {% if noticias is empty %}
                        <div class="alert alert-secondary">No hay noticias para esta fecha. Mostrando las √∫ltimas 10.</div>
                    {% endif %}
                    
                    {% for noticia in noticias %}
                        {% set plainContent = noticia.content|striptags %}
                        <div class="card mb-2 news-card {{ noticia.featured ? 'border-warning' : '' }}" style="cursor: pointer; {{ noticia.featured ? 'background-color: #fffbf0;' : '' }}" 
                             data-bs-toggle="modal" data-bs-target="#newsDetailModal"
                             data-news-id="{{ noticia.id }}"
                             data-news-title="{{ noticia.title|e('html_attr') }}"
                             data-news-content="{{ noticia.content|e('html_attr') }}"
                             data-news-image="{{ noticia.image|default('')|e('html_attr') }}"
                             data-news-date="{{ noticia.createdAt|date('d/m/Y') }}"
                             data-news-category="{{ noticia.category|default('')|e('html_attr') }}">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-start">
                                    {% if noticia.image %}
                                        <img src="{{ noticia.image }}" width="60" height="60" class="rounded me-2 object-fit-cover" alt="">
                                    {% endif %}
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between">
                                            <strong class="d-block" style="font-size: 0.9rem">
                                                {% if noticia.featured %}
                                                    <span class="badge bg-warning text-dark me-1" style="font-size: 0.6rem">‚≠ê Destacado</span>
                                                {% endif %}
                                                {{ noticia.title }}
                                            </strong>
                                        </div>
                                        <small class="text-muted d-block">
                                            {{ plainContent|length > 80 ? plainContent|slice(0, 80) ~ '...' : plainContent }}
                                        </small>
                                        <div class="mt-1">
                                            {% if noticia.category %}
                                                <span class="badge {% if noticia.category == 'fichaje' %}bg-success{% elseif noticia.category == 'lesion' %}bg-danger{% elseif noticia.category == 'sancion' %}bg-warning{% else %}bg-secondary{% endif %}">
                                                    {{ noticia.category|capitalize }}
                                                </span>
                                            {% endif %}
                                            <small class="text-muted ms-2">{{ noticia.createdAt|date('d/m/Y') }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        
        <div class="col-md-8">
            
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <a href="?date={{ fechaActual }}&orden=tops" 
                    class="btn btn-sm {{ ordenActual == 'tops' ? 'btn-primary' : 'btn-outline-primary' }}">
                        üèÜ Por ligas tops
                    </a>
                    <a href="?date={{ fechaActual }}&orden=pais" 
                    class="btn btn-sm {{ ordenActual == 'pais' ? 'btn-primary' : 'btn-outline-primary' }}">
                        üåç Por pa√≠s
                    </a>
                </div>
            </div>
            {% if partidosPorLiga is empty %}
                <div class="alert alert-info">No hay partidos para esta fecha.</div>
            {% else %}
                
                {% if ordenActual == 'pais' %}
                    <div class="accordion" id="accordionPaises">
                        {% for pais, dataPais in partidosPorPais %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ loop.index }}">
                                    <button class="accordion-button {{ loop.first ? '' : 'collapsed' }}" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" 
                                            aria-expanded="{{ loop.first ? 'true' : 'false' }}" aria-controls="collapse{{ loop.index }}">
                                        <strong>üåç {{ dataPais.pais }}</strong>
                                        <span class="badge bg-secondary ms-2">{{ dataPais.ligas|length }} ligas</span>
                                    </button>
                                </h2>
                                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {{ loop.first ? 'show' : '' }}" 
                                     aria-labelledby="heading{{ loop.index }}" data-bs-parent="#accordionPaises">
                                    <div class="accordion-body p-2">
                                        {% for dataLiga in dataPais.ligas %}
                                            <div class="card mb-2">
                                                <div class="card-header bg-dark text-white d-flex align-items-center py-1">
                                                    {% if dataLiga.logo %}
                                                        <img src="{{ dataLiga.logo }}" width="20" class="me-2">
                                                    {% endif %}
                                                    <strong>{{ dataLiga.nombre }}</strong>
                                                </div>
                                                <div class="card-body p-1">

                                                    {% for match in dataLiga.partidos %}
                                                        <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                                                            
                                                            <div class="text-center" style="width: 35%">
                                                                <a href="{{ path('team_show', {id: match.teams.home.id}) }}" class="text-decoration-none text-dark d-block p-1 hover-effect">
                                                                    <img src="{{ match.teams.home.logo }}" width="25">
                                                                    <small class="d-block" style="font-size: 0.75rem">{{ match.teams.home.name }}</small>
                                                                </a>
                                                            </div>

                                                            
                                                            <div class="text-center" style="width: 30%">
                                                                <a href="{{ path('match_show', {id: match.fixture.id}) }}" class="text-decoration-none text-dark d-block p-1 hover-impact">
                                                                    {% if match.fixture.status.short == 'FT' %}
                                                                        <span class="badge bg-secondary" style="font-size: 0.65rem">FIN</span><br>
                                                                        <strong style="font-size: 0.85rem">{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                                    {% elseif match.fixture.status.short == 'HT' %}
                                                                        <span class="badge bg-warning text-dark" style="font-size: 0.65rem">‚è∏Ô∏è DESCANSO</span><br>
                                                                        <strong style="font-size: 0.85rem">{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                                    {% elseif match.fixture.status.short in ['1H', '2H', 'ET', 'P', 'BT', 'LIVE'] %}
                                                                        <span class="badge bg-danger" style="font-size: 0.65rem">üî¥ {{ match.fixture.status.elapsed }}'</span><br>
                                                                        <strong style="font-size: 0.85rem">{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                                    {% elseif match.fixture.status.short == 'PST' %}
                                                                        <span class="badge bg-dark" style="font-size: 0.65rem">‚ö†Ô∏è APLAZADO</span>
                                                                    {% elseif match.fixture.status.short in ['CANC', 'ABD', 'AWD', 'WO', 'INT', 'SUSP'] %}
                                                                        <span class="badge bg-dark" style="font-size: 0.65rem">‚ùå {{ match.fixture.status.long }}</span>
                                                                    {% elseif match.fixture.status.short == 'AET' %}
                                                                        <span class="badge bg-secondary" style="font-size: 0.65rem">FIN (Pr√≥rroga)</span><br>
                                                                        <strong style="font-size: 0.85rem">{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                                    {% elseif match.fixture.status.short == 'PEN' %}
                                                                        <span class="badge bg-secondary" style="font-size: 0.65rem">FIN (Penaltis)</span><br>
                                                                        <strong style="font-size: 0.85rem">{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                                    {% else %}
                                                                        <span class="badge bg-primary" style="font-size: 0.65rem">{{ match.fixture.date|date_modify('+1 hour')|date('H:i') }}</span>
                                                                    {% endif %}
                                                                </a>
                                                            </div>

                                                            
                                                            <div class="text-center" style="width: 35%">
                                                                <a href="{{ path('team_show', {id: match.teams.away.id}) }}" class="text-decoration-none text-dark d-block p-1 hover-effect">
                                                                    <img src="{{ match.teams.away.logo }}" width="25">
                                                                    <small class="d-block" style="font-size: 0.75rem">{{ match.teams.away.name }}</small>
                                                                </a>
                                                            </div>
                                                            {% if is_granted('ROLE_ADMIN') %}
                                                                <a href="{{ path('admin_news_new', {fixtureId: match.fixture.id}) }}" 
                                                                   class="btn btn-warning btn-sm ms-1" 
                                                                   style="font-size: 0.6rem; padding: 2px 4px;" 
                                                                   title="Crear noticia sobre este partido">
                                                                    üì∞
                                                                </a>
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    
                    {% for nombreLiga, dataLiga in partidosPorLiga %}
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white d-flex align-items-center">
                                {% if dataLiga.logo %}
                                    <img src="{{ dataLiga.logo }}" width="25" class="me-2">
                                {% endif %}
                                <strong>{{ dataLiga.nombre }}</strong>
                                <small class="ms-2 text-muted">{{ dataLiga.country }}</small>
                            </div>
                            <div class="card-body p-2">
                                {% for match in dataLiga.partidos %}
                                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                        <div class="text-center" style="width: 35%">
                                            <a href="{{ path('team_show', {id: match.teams.home.id}) }}" class="text-decoration-none text-dark d-block p-1 hover-effect">
                                                <img src="{{ match.teams.home.logo }}" width="30">
                                                <small class="d-block">{{ match.teams.home.name }}</small>
                                            </a>
                                        </div>
                                        <div class="text-center" style="width: 30%">
                                            <a href="{{ path('match_show', {id: match.fixture.id}) }}" class="text-decoration-none text-dark d-block p-1 hover-impact">
                                                {% if match.fixture.status.short == 'FT' %}
                                                    <span class="badge bg-secondary">FIN</span><br>
                                                    <strong>{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                {% elseif match.fixture.status.short == 'HT' %}
                                                    <span class="badge bg-warning text-dark">‚è∏Ô∏è DESCANSO</span><br>
                                                    <strong>{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                {% elseif match.fixture.status.short in ['1H', '2H', 'ET', 'P', 'BT', 'LIVE'] %}
                                                    <span class="badge bg-danger">üî¥ {{ match.fixture.status.elapsed }}'</span><br>
                                                    <strong>{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                {% elseif match.fixture.status.short == 'PST' %}
                                                    <span class="badge bg-dark">‚ö†Ô∏è APLAZADO</span>
                                                {% elseif match.fixture.status.short in ['CANC', 'ABD', 'AWD', 'WO', 'INT', 'SUSP'] %}
                                                    <span class="badge bg-dark">‚ùå {{ match.fixture.status.long }}</span>
                                                {% elseif match.fixture.status.short == 'AET' %}
                                                    <span class="badge bg-secondary">FIN (Pr√≥rroga)</span><br>
                                                    <strong>{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                {% elseif match.fixture.status.short == 'PEN' %}
                                                    <span class="badge bg-secondary">FIN (Penaltis)</span><br>
                                                    <strong>{{ match.goals.home }} - {{ match.goals.away }}</strong>
                                                {% else %}
                                                    <span class="badge bg-primary">{{ match.fixture.date|date_modify('+1 hour')|date('H:i') }}</span>
                                                {% endif %}
                                            </a>
                                        </div>
                                        <div class="text-center" style="width: 35%">
                                            <a href="{{ path('team_show', {id: match.teams.away.id}) }}" class="text-decoration-none text-dark d-block p-1 hover-effect">
                                                <img src="{{ match.teams.away.logo }}" width="30">
                                                <small class="d-block">{{ match.teams.away.name }}</small>
                                            </a>
                                        </div>
                                        {% if is_granted('ROLE_ADMIN') %}
                                            <a href="{{ path('admin_news_new', {fixtureId: match.fixture.id}) }}" 
                                               class="btn btn-warning btn-sm ms-2" 
                                               style="font-size: 0.7rem;" 
                                               title="Crear noticia sobre este partido">
                                                üì∞ Noticia
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>


{% endblock %}